<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¬Ù…Ø¹ÙŠØ© Ø¢Ù„ Ø¨ÙˆØ¹ÙˆØ¬Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #1a73e8; --secondary: #34a853; --danger: #ea4335; 
            --warning: #fbbc04; --purple: #9b59b6; --sidebar-bg: #fff; --main-bg: #f8f9fa; 
        }
        body { font-family: 'Cairo', sans-serif; margin: 0; background: var(--main-bg); display: flex; height: 100vh; overflow: hidden; flex-direction: column; }
        
        #portal-screen { position: fixed; inset: 0; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; gap: 20px; }
        .portal-card { width: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; background: white; border: 1px solid #eee; }
        
        .search-container { position: relative; width: 100%; }
        .suggestions-box { 
            position: absolute; top: 100%; left: 0; right: 0; background: #fff; 
            border: 1px solid #ddd; border-radius: 0 0 12px 12px; z-index: 1001; 
            max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .suggestion-item { padding: 12px; cursor: pointer; text-align: right; border-bottom: 1px solid #f0f0f0; font-size: 14px; transition: 0.2s; }
        .suggestion-item:hover { background: #f1f3f4; color: var(--primary); font-weight: bold; }

        .app-container { display: flex; flex: 1; overflow: hidden; }

        .sidebar { width: 280px; background: var(--sidebar-bg); border-left: 1px solid #ddd; display: none; flex-direction: column; padding: 20px 0; }
        .sidebar-header { text-align: center; color: var(--primary); font-weight: bold; font-size: 22px; margin-bottom: 30px; padding: 0 10px; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.3s; color: #5f6368; font-weight: 600; }
        .nav-item:hover, .nav-item.active { background: #f1f3f4; color: var(--primary); border-right: 5px solid var(--primary); }
        
        .main-content { flex: 1; display: none; flex-direction: column; overflow-y: auto; padding: 30px; padding-bottom: 80px; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .card { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #eee; position: relative; overflow: hidden; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.02); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .stat-card h4 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .stat-card b { font-size: 22px; display: block; color: #333; }
        .stat-card::after { content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; }
        .stat-card.blue::after { background: var(--primary); }
        .stat-card.green::after { background: var(--secondary); }
        .stat-card.red::after { background: var(--danger); }
        .stat-card.orange::after { background: var(--warning); }
        .stat-card.purple::after { background: var(--purple); }
        
        .log-container { margin-top: 20px; border: 1px solid #f0f0f0; border-radius: 20px; overflow: hidden; background: #fff; }
        .log-table { width: 100%; border-collapse: collapse; }
        .log-table th { background: #f8f9fa; padding: 15px; font-size: 14px; text-align: right; color: #555; }
        .log-table td { padding: 15px; border-bottom: 1px solid #fcfcfc; font-size: 14px; }

        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-family: 'Cairo'; outline: none; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: #fff; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-main:hover { opacity: 0.9; }
        .btn-msg { margin-top: 10px; font-weight: bold; }
        
        .staff-actions button { padding: 5px 10px; border-radius: 8px; border: none; cursor: pointer; font-family: 'Cairo'; margin-left: 5px; color: white; }

        .master-footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255, 255, 255, 0.95); padding: 12px 0; text-align: center; 
            border-top: 1px solid #eee; font-size: 13px; color: #555; z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .master-footer b { color: var(--primary); }
    </style>
</head>
<body>

    <div id="portal-screen">
        <div id="public-view" class="portal-card">
            <h2 style="color: var(--primary);">Ø¬Ù…Ø¹ÙŠØ© Ø¢Ù„ Ø¨ÙˆØ¹ÙˆØ¬Ø©</h2>
            <div class="search-container">
                <input type="text" id="publicSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." oninput="handleAutocomplete(this.value, 'suggestions', 'publicSearch')">
                <div id="suggestions" class="suggestions-box"></div>
            </div>
            <button class="btn-main" onclick="publicQuery()">Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
            <div id="publicResult" style="display:none;"></div>
            <button style="background:none; border:none; color:var(--primary); cursor:pointer; font-family:'Cairo'; margin-top: 25px;" onclick="toggleLogin(true)">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† â†</button>
        </div>
        <div id="login-view" class="portal-card" style="display:none;">
            <h2 style="color: var(--primary);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="userIn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="passIn" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button class="btn-main" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
            <button style="background:none; border:none; color:#999; cursor:pointer; margin-top:15px;" onclick="toggleLogin(false)">Ø¹ÙˆØ¯Ø©</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar" id="app-sidebar">
            <div class="sidebar-header">Ø¬Ù…Ø¹ÙŠØ© Ø¢Ù„ Ø¨ÙˆØ¹ÙˆØ¬Ø©</div>
            <div class="nav-item active" onclick="showSection('search-section')">ğŸ” Ø¨Ø­Ø« ÙˆØ§Ø³ØªØ¹Ù„Ø§Ù…</div>
            <div class="nav-item" onclick="showSection('msg-center')">ğŸ’¬ Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
            <div class="nav-item" onclick="showSection('add-member')">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</div>
            <div class="nav-item" onclick="showSection('pay-section')">ğŸ’µ Ø¯ÙØ¹ Ø§Ø´ØªØ±Ø§Ùƒ</div>
            <div class="nav-item" onclick="showSection('edit-section')">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            <div class="nav-item" id="staff-nav" onclick="showSection('staff-section')">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
            <div class="nav-item" onclick="showSection('report-section')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
            <div class="nav-item" style="color:var(--danger)" onclick="logoutApp()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
        </div>

        <div class="main-content" id="app-content">
            <div id="search-section" class="view-section active">
                <div class="card">
                    <h3>ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¥Ø¯Ø§Ø±ÙŠ Ø°ÙƒÙŠ</h3>
                    <div class="search-container">
                        <input type="text" id="mainSearch" placeholder="Ø§ÙƒØªØ¨ Ø­Ø±ÙØ§Ù‹ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¶Ùˆ..." oninput="handleAutocomplete(this.value, 'adminSuggestions', 'mainSearch', 'search')">
                        <div id="adminSuggestions" class="suggestions-box"></div>
                    </div>
                    <div id="adminDetailView" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="pay-section" class="view-section">
                <div class="card">
                    <h3>ğŸ’µ Ø¯ÙØ¹ Ù‚ÙŠÙ…Ø© Ø§Ø´ØªØ±Ø§Ùƒ</h3>
                    <div class="search-container">
                        <input type="text" id="paySearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ù„ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹..." oninput="handleAutocomplete(this.value, 'paySuggestions', 'paySearch', 'pay')">
                        <div id="paySuggestions" class="suggestions-box"></div>
                    </div>
                    <div id="payActionArea" style="display:none; padding:20px; border:1px solid var(--secondary); border-radius:15px; margin-top: 20px;">
                        <input type="hidden" id="payIdx">
                        <h4 id="payTargetName" style="margin-top:0"></h4>
                        <p id="payBalancePreview" style="font-size:14px; color:#666;"></p>
                        <label>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¯ÙØ¹Ù‡Ø§ Ø§Ù„Ø¢Ù†:</label>
                        <input type="number" id="payAmountInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±">
                        <button class="btn-main" style="background:var(--secondary)" onclick="processPayment()">ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹</button>
                    </div>
                </div>
            </div>

            <div id="msg-center" class="view-section">
                <div class="card">
                    <h3>ğŸ’¬ Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</h3>
                    <div class="search-container">
                        <input type="text" id="msgSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©..." oninput="handleAutocomplete(this.value, 'msgSuggestions', 'msgSearch', 'msg')">
                        <div id="msgSuggestions" class="suggestions-box"></div>
                    </div>
                    <div id="msgActionArea" style="display:none; padding:20px; border:1px solid var(--primary); border-radius:15px; margin-top: 20px;">
                        <h4 id="msgTargetName" style="margin-top:0"></h4>
                        <p id="msgStatusPreview" style="font-size:13px; color:#666;"></p>
                        <hr style="border:0; border-top:1px solid #eee;">
                        <button class="btn-main btn-msg" style="background:#25D366" onclick="sendMsg('wa')">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± WhatsApp</button>
                        <button class="btn-main btn-msg" style="background:#333" onclick="sendMsg('sms')">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± SMS</button>
                    </div>
                </div>
            </div>

            <div id="staff-section" class="view-section">
                <div class="card">
                    <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                    <div id="staffAdminForm" style="display:none; background:#f9f9f9; padding:20px; border-radius:15px; margin-bottom:20px;">
                        <input type="hidden" id="stfIdx">
                        <input type="text" id="stfName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                        <input type="text" id="stfUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                        <input type="password" id="stfPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                        <button class="btn-main" id="stfBtn" onclick="saveStaff()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                    <div id="staffTableArea"></div>
                    <p id="staffDenyMsg" style="color:red; text-align:center; display:none;">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·.</p>
                </div>
            </div>

            <div id="edit-section" class="view-section">
                <div class="card">
                    <h3>âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                    <div class="search-container">
                        <input type="text" id="editSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„..." oninput="handleAutocomplete(this.value, 'editSuggestions', 'editSearch', 'edit')">
                        <div id="editSuggestions" class="suggestions-box"></div>
                    </div>
                    <div id="editFields" style="display:none; margin-top:20px; background:#fcfcfc; padding:20px; border-radius:15px;">
                        <input type="hidden" id="idxField">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label><input type="text" id="upMemName">
                        <label>Ø³Ù†Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label><select id="upMemYear"></select>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="upMemPhone">
                        <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹</label><input type="number" id="upMemAmount">
                        <button class="btn-main" onclick="updateMember()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                        <button class="btn-main" style="background:var(--danger); margin-top:10px;" onclick="deleteMember()">Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
                    </div>
                </div>
            </div>

            <div id="add-member" class="view-section">
                <div class="card">
                    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</h3>
                    <input type="text" id="inMemName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
                    <input type="number" id="inMemAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                    <select id="inMemYear"></select>
                    <input type="text" id="inMemPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                    <button class="btn-main" onclick="addMember()">Ø­ÙØ¸</button>
                </div>
            </div>

            <div id="report-section" class="view-section">
                <div class="stats-grid">
                    <div class="stat-card blue"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h4><b id="stTotal">0</b></div>
                    <div class="stat-card green"><h4>Ø§Ù„Ù…Ø³Ø¯Ø¯ÙŠÙ† âœ…</h4><b id="stPaid">0</b></div>
                    <div class="stat-card red"><h4>ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¯Ø¯ÙŠÙ† âŒ</h4><b id="stUnpaid">0</b></div>
                    <div class="stat-card orange"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</h4><b id="stBalance">0</b></div>
                    <div class="stat-card purple"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h4><b id="stRem">0</b></div>
                </div>
                <div class="card">
                    <h4>ğŸ“œ Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
                    <div class="log-container"><table class="log-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="logsBody"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <div class="master-footer">
        ØªØ·ÙˆÙŠØ± ÙˆØ¨Ø±Ù…Ø¬Ø© Ø¨ÙˆØ§Ø³Ø·Ø© <b>Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¹Ø·ÙŠØ©</b> | Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¹Ø§Ù… 2025-2026 Â©
    </div>

    <script>
        const subFee = 120;
        let staff = JSON.parse(localStorage.getItem('staff_db')) || [{ name: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…", user: "admin", pass: "123", role: "admin" }];
        let members = JSON.parse(localStorage.getItem('members_db')) || [];
        let logs = JSON.parse(localStorage.getItem('logs_db')) || [];
        let activeUser = null;

        function initYears() {
            const sels = [document.getElementById('inMemYear'), document.getElementById('upMemYear')];
            sels.forEach(s => { s.innerHTML = ""; for(let y=2025; y<=2125; y++) { s.innerHTML += `<option value="${y}">${y}</option>`; } });
        }

        function handleAutocomplete(val, boxId, inputId, type = 'public') {
            const box = document.getElementById(boxId);
            if (val.trim() === "") { box.style.display = "none"; return; }
            const filtered = members.filter(m => m.name.includes(val.trim()));
            if (filtered.length > 0) {
                box.innerHTML = filtered.map(m => {
                    const idx = members.indexOf(m);
                    return `<div class="suggestion-item" onclick="selectSuggestion('${m.name}', ${idx}, '${boxId}', '${inputId}', '${type}')">${m.name}</div>`;
                }).join('');
                box.style.display = "block";
            } else { box.style.display = "none"; }
        }

        function selectSuggestion(name, index, boxId, inputId, type) {
            document.getElementById(inputId).value = name;
            document.getElementById(boxId).style.display = "none";
            if (type === 'search') showAdminDetail(index);
            if (type === 'edit') selectMember(index, 'edit');
            if (type === 'msg') selectMember(index, 'msg');
            if (type === 'pay') selectMember(index, 'pay');
        }

        function getMemberStatus(amt) {
            if (amt >= subFee) return { text: "Ù…Ø³Ø¯Ø¯ âœ…", color: "green" };
            if (amt > 0 && amt < subFee) return { text: "Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ âš ï¸", color: "orange" };
            return { text: "ØºÙŠØ± Ù…Ø³Ø¯Ø¯ âŒ", color: "red" };
        }

        function showAdminDetail(idx) {
            const m = members[idx];
            const status = getMemberStatus(m.amount);
            const detail = document.getElementById('adminDetailView');
            detail.style.display = "block";
            detail.innerHTML = `
                <div style="background:#f8f9fa; padding:20px; border-radius:15px; border-right: 5px solid ${status.color}">
                    <h3 style="margin:0">${m.name}</h3>
                    <p>Ø§Ù„Ø­Ø§Ù„Ø©: <b style="color:${status.color}">${status.text} Ù„Ø¹Ø§Ù… ${m.year}</b></p>
                    <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙƒÙ„ÙŠØ§Ù‹: ${m.amount} Ø¯.Ù„ | Ø§Ù„Ù‡Ø§ØªÙ: ${m.phone}</p>
                </div>`;
        }

        function processPayment() {
            const idx = document.getElementById('payIdx').value;
            const amt = Number(document.getElementById('payAmountInput').value);
            if (amt <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
            
            members[idx].amount += amt;
            localStorage.setItem('members_db', JSON.stringify(members));
            addLog("Ø¯ÙØ¹ Ø§Ø´ØªØ±Ø§Ùƒ", amt);
            alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById('payAmountInput').value = "";
            document.getElementById('payActionArea').style.display = "none";
            document.getElementById('paySearch').value = "";
            updateStats();
        }

        function logoutApp() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                activeUser = null;
                document.getElementById('app-sidebar').style.display = 'none';
                document.getElementById('app-content').style.display = 'none';
                document.getElementById('portal-screen').style.display = 'flex';
                toggleLogin(false);
            }
        }

        function toggleLogin(show) {
            document.getElementById('public-view').style.display = show ? 'none' : 'block';
            document.getElementById('login-view').style.display = show ? 'block' : 'none';
        }

        function handleLogin() {
            const u = document.getElementById('userIn').value, p = document.getElementById('passIn').value;
            const found = staff.find(s => s.user === u && s.pass === p);
            if(found) {
                activeUser = found;
                document.getElementById('portal-screen').style.display = 'none';
                document.getElementById('app-sidebar').style.display = 'flex';
                document.getElementById('app-content').style.display = 'flex';
                renderStaff(); updateStats(); renderLogs();
                document.getElementById('userIn').value = ""; document.getElementById('passIn').value = "";
            } else { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©"); }
        }

        function publicQuery() {
            const term = document.getElementById('publicSearch').value.trim();
            const resDiv = document.getElementById('publicResult');
            const f = members.find(m => m.name === term);
            if(f) {
                const status = getMemberStatus(f.amount);
                resDiv.style.display = "block";
                resDiv.innerHTML = `<div style="background:var(--primary); color:#fff; padding:20px; border-radius:15px; margin-top:15px;">
                    <h3>${f.name}</h3>
                    <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${f.amount} Ø¯.Ù„</p>
                    <p style="background:${status.color === 'orange' ? '#fbbc04' : ''}; padding:5px; border-radius:5px;">Ø§Ù„Ø­Ø§Ù„Ø©: ${status.text} Ù„Ø¹Ø§Ù… ${f.year}</p>
                </div>`;
            } else { alert("Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª"); }
        }

        function showSection(id) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const target = document.querySelector(`.nav-item[onclick="showSection('${id}')"]`);
            if(target) target.classList.add('active');
            document.getElementById(id).classList.add('active');
            updateStats();
        }

        function renderStaff() {
            const isAdmin = activeUser && activeUser.role === 'admin';
            document.getElementById('staffAdminForm').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('staffDenyMsg').style.display = isAdmin ? 'none' : 'block';
            let h = '<table class="log-table"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>';
            staff.forEach((s, i) => {
                let actions = isAdmin ? `<button onclick="editStaff(${i})" style="background:orange">ØªØ¹Ø¯ÙŠÙ„</button>` : '---';
                if(isAdmin && s.role !== 'admin') actions += `<button onclick="deleteStaff(${i})" style="background:red">Ø­Ø°Ù</button>`;
                h += `<tr><td>${s.name}</td><td>${s.user}</td><td class="staff-actions">${actions}</td></tr>`;
            });
            document.getElementById('staffTableArea').innerHTML = h + '</table>';
        }

        function saveStaff() {
            const idx = document.getElementById('stfIdx').value;
            const n = document.getElementById('stfName').value, u = document.getElementById('stfUser').value, p = document.getElementById('stfPass').value;
            if(idx === "") staff.push({ name: n, user: u, pass: p, role: "user" });
            else { staff[idx].name = n; staff[idx].user = u; staff[idx].pass = p; document.getElementById('stfIdx').value = ""; }
            localStorage.setItem('staff_db', JSON.stringify(staff)); renderStaff();
        }

        function selectMember(i, type) {
            const m = members[i]; window.selectedMember = m;
            if(type === 'edit') {
                document.getElementById('editFields').style.display = 'block';
                document.getElementById('idxField').value = i;
                document.getElementById('upMemName').value = m.name;
                document.getElementById('upMemPhone').value = m.phone;
                document.getElementById('upMemAmount').value = m.amount;
                document.getElementById('upMemYear').value = m.year;
            }
            if(type === 'msg') {
                document.getElementById('msgActionArea').style.display = 'block';
                document.getElementById('msgTargetName').innerText = "Ø§Ù„Ù…Ø³ØªÙ„Ù…: " + m.name;
                const status = getMemberStatus(m.amount);
                document.getElementById('msgStatusPreview').innerText = `Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø¶Ùˆ: ${status.text} (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${m.amount} Ø¯.Ù„)`;
            }
            if(type === 'pay') {
                document.getElementById('payActionArea').style.display = 'block';
                document.getElementById('payIdx').value = i;
                document.getElementById('payTargetName').innerText = m.name;
                document.getElementById('payBalancePreview').innerText = `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨: ${m.amount} Ø¯.Ù„`;
            }
        }

        function sendMsg(mode) {
            const m = window.selectedMember;
            let msg = "";
            const status = getMemberStatus(m.amount);
            
            msg = `ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© Ù…Ù† Ø¬Ù…Ø¹ÙŠØ© Ø¢Ù„ Ø¨ÙˆØ¹ÙˆØ¬Ø© ğŸŒ¹\n\nØ§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø­ØªØ±Ù…: ${m.name}\nÙ†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§ÙƒÙƒÙ… Ù„Ø¹Ø§Ù… ${m.year}.\nØ§Ù„Ø­Ø§Ù„Ø©: ${status.text}\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯: ${m.amount} Ø¯ÙŠÙ†Ø§Ø±.\n\nÙ†Ø´ÙƒØ±ÙƒÙ… Ø¹Ù„Ù‰ Ø¯Ø¹Ù…ÙƒÙ… Ø§Ù„Ù…Ø³ØªÙ…Ø±.\nØ¯Ù…ØªÙ… Ø¨Ø®ÙŠØ±.`;

            const url = mode === 'wa' ? `https://wa.me/${m.phone}?text=${encodeURIComponent(msg)}` : `sms:${m.phone}?body=${encodeURIComponent(msg)}`;
            window.open(url);
        }

        function addMember() {
            const n = document.getElementById('inMemName').value, a = Number(document.getElementById('inMemAmount').value);
            if(!n) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
            members.push({ name: n, amount: a, phone: document.getElementById('inMemPhone').value, year: document.getElementById('inMemYear').value });
            localStorage.setItem('members_db', JSON.stringify(members)); addLog("Ø¥Ø¶Ø§ÙØ©", a); 
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); document.getElementById('inMemName').value=""; document.getElementById('inMemAmount').value="";
        }

        function updateMember() {
            const i = document.getElementById('idxField').value;
            members[i] = { name: document.getElementById('upMemName').value, year: document.getElementById('upMemYear').value, phone: document.getElementById('upMemPhone').value, amount: Number(document.getElementById('upMemAmount').value) };
            localStorage.setItem('members_db', JSON.stringify(members)); addLog("ØªØ¹Ø¯ÙŠÙ„", members[i].amount); 
            alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­"); document.getElementById('editFields').style.display = 'none';
            updateStats();
        }

        function deleteMember() { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ")) { members.splice(document.getElementById('idxField').value, 1); localStorage.setItem('members_db', JSON.stringify(members)); document.getElementById('editFields').style.display = 'none'; alert("ØªÙ… Ø§Ù„Ø­Ø°Ù"); updateStats(); } }

        function addLog(t, a) { logs.unshift({ time: new Date().toLocaleString('ar-EG'), type: t, user: activeUser.name, amount: a + " Ø¯.Ù„" }); if(logs.length > 20) logs.pop(); localStorage.setItem('logs_db', JSON.stringify(logs)); renderLogs(); }

        function renderLogs() { document.getElementById('logsBody').innerHTML = logs.map(l => `<tr><td>${l.time}</td><td>${l.type}</td><td>${l.user}</td><td>${l.amount}</td></tr>`).join(''); }

        function updateStats() {
            const total = members.length;
            const balance = members.reduce((s, m) => s + m.amount, 0);
            const paid = members.filter(m => m.amount >= subFee).length;
            const unpaid = total - paid;
            const totalRequired = total * subFee;
            const rem = Math.max(0, totalRequired - balance);

            document.getElementById('stTotal').innerText = total;
            document.getElementById('stPaid').innerText = paid;
            document.getElementById('stUnpaid').innerText = unpaid;
            document.getElementById('stBalance').innerText = balance.toLocaleString() + " Ø¯.Ù„";
            document.getElementById('stRem').innerText = rem.toLocaleString() + " Ø¯.Ù„";
        }

        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('suggestion-item') && e.target.tagName !== 'INPUT') {
                document.querySelectorAll('.suggestions-box').forEach(b => b.style.display = 'none');
            }
        });

        initYears();
    </script>
</body>
</html>
